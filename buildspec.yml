version: 0.2

phases:
  install:
    runtime-versions:
      php: 8.3 # Use PHP 8.3 runtime
    commands:
      - echo "ğŸ“¦ Installing Composer and Laravel dependencies..."

      # Install Composer locally (without global install)
      - curl -sS https://getcomposer.org/installer | php
      - php composer.phar install --no-interaction --prefer-dist --optimize-autoloader
      - echo "âœ… Composer dependencies installed."

      # Install additional system packages if needed (e.g., SQLite for testing)
      - echo "ğŸ“¥ Installing additional system dependencies..."
      - export DEBIAN_FRONTEND=noninteractive
      - apt-get update
      - apt-get install -y sqlite3
      - echo "âœ… System dependencies installed."

  pre_build:
    commands:
      - echo "ğŸ”§ Preparing Laravel environment..."

      # Copy production environment file if it exists
      - if [ -f .env.production ]; then cp .env.production .env; else cp .env.example .env; fi
      - echo "ğŸ“„ Environment file set."

      # Optional: Create empty SQLite file if DB_CONNECTION is set to sqlite
      - if grep -q "DB_CONNECTION=sqlite" .env; then touch database/database.sqlite; fi
      - echo "ğŸ—ƒï¸ SQLite database initialized if needed."

      # Run database migrations
      - echo "ğŸ§± Running Laravel migrations..."
      - php artisan migrate --force

      # Generate application encryption key
      - echo "ğŸ”‘ Generating Laravel app key..."
      - php artisan key:generate --force

      # Laravel optimization (combines config, route, and view caching)
      - echo "ğŸš€ Running Laravel optimization commands..."
      - php artisan optimize
      - echo "âœ… Laravel optimized."

  build:
    commands:
      - echo "ğŸ§ª Running Laravel unit tests..."
      - php artisan test --testsuite=Unit --stop-on-failure

      - echo "âœ… Build and testing phase completed."

  post_build:
    commands:
      - echo "ğŸš€ Post-build: Ready for deployment trigger or next pipeline stage."
